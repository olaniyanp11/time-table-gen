<%- include('../../partials/header') %>

<div class="p-6">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-bold">All Courses</h2>
    <button onclick="openCourseModal()" class="bg-[#9d5b1e] text-white px-4 py-2 rounded hover:bg-[#7a441a]">
      + Add Course
    </button>
  </div>

  <!-- Courses Table -->
  <div class="overflow-x-auto bg-white rounded shadow">
    <table class="min-w-full border-collapse">
      <thead class="bg-[#9d5b1e] text-white">
        <tr>
          <th class="px-4 py-2 text-left">Code</th>
          <th class="px-4 py-2 text-left">Title</th>
          <th class="px-4 py-2 text-left">Unit</th>
          <th class="px-4 py-2 text-left">Department</th>
          <th class="px-4 py-2 text-left">Lecturer</th>
          <th class="px-4 py-2 text-left">Level</th>
          <th class="px-4 py-2 text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if (courses && courses.length > 0) { %>
          <% courses.forEach(course => { %>
            <tr class="border-b hover:bg-gray-100">
              <td class="px-4 py-2"><%= course.code %></td>
              <td class="px-4 py-2"><%= course.title %></td>
              <td class="px-4 py-2"><%= course.unit %></td>
              <td class="px-4 py-2"><%= course.department %></td>
              <td class="px-4 py-2"><%= course.lecturer ? course.lecturer.name : '—' %></td>
              <td class="px-4 py-2"><%= course.level && course.level.length ? course.level.join(', ') : '—' %></td>
              <td class="px-4 py-2 text-center space-x-2">
                <button onclick="openEditCourseModal(<%= JSON.stringify(course) %>)" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">Edit</button>
                <form action="/admin/del-courses/<%= course._id %>" method="POST" class="inline">
                  <button type="submit" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">Delete</button>
                </form>
              </td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="7" class="px-4 py-4 text-center text-gray-500">No courses found.</td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<!-- Course Modal (Add/Edit) -->
<div id="courseModal" class="fixed inset-0 bg-[#0000005d] hidden flex items-center justify-center z-50">
  <div class="bg-white p-8 rounded-lg shadow-lg w-96 relative">
    <h3 id="courseModalTitle" class="text-2xl font-semibold text-center mb-6">Add Course</h3>

    <form id="courseForm" method="POST" class="space-y-4">
      <div>
        <label class="block mb-1 font-medium">Course Code</label>
        <input type="text" name="code" required class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-[#9d5b1e]" />
      </div>
      <div>
        <label class="block mb-1 font-medium">Title</label>
        <input type="text" name="title" required class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-[#9d5b1e]" />
      </div>
      <div>
        <label class="block mb-1 font-medium">Unit</label>
        <input type="number" name="unit" min="1" max="6" required class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-[#9d5b1e]" />
      </div>
      <div>
        <label class="block mb-1 font-medium">Department</label>
        <input type="text" name="department" required class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-[#9d5b1e]" />
      </div>
      <div>
        <label class="block mb-1 font-medium">Lecturer</label>
        <select name="lecturer" required class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-[#9d5b1e]">
          <option value="">Select Lecturer</option>
          <% lecturers.forEach(lec => { %>
            <option value="<%= lec._id %>"><%= lec.name %> (<%= lec.department %>)</option>
          <% }) %>
        </select>
      </div>
      <div>
        <label class="block mb-1 font-medium">Level</label>
        <select name="level" multiple class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-[#9d5b1e]">
          <option value="ND1">ND1</option>
          <option value="ND2">ND2</option>
          <option value="HND1">HND1</option>
          <option value="HND2">HND2</option>
        </select>
      </div>

      <div class="flex justify-end space-x-2">
        <button type="button" onclick="closeCourseModal()" class="px-4 py-2 rounded border">Cancel</button>
        <button type="submit" id="courseSubmitBtn" class="bg-[#9d5b1e] text-white px-4 py-2 rounded hover:bg-[#7a441a]">Save</button>
      </div>

      <div id="courseLoader" class="hidden flex justify-center mt-4">
        <div class="w-6 h-6 border-4 border-[#9d5b1e] border-t-transparent rounded-full animate-spin"></div>
      </div>
    </form>

    <button onclick="closeCourseModal()" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700">&times;</button>
  </div>
</div>

<script>
  const courseModal = document.getElementById("courseModal");
  const courseForm = document.getElementById("courseForm");
  const courseLoader = document.getElementById("courseLoader");
  const courseSubmitBtn = document.getElementById("courseSubmitBtn");
  const courseModalTitle = document.getElementById("courseModalTitle");

  function openCourseModal() {
    courseModalTitle.textContent = "Add Course";
    courseForm.action = "/admin/courses";
    courseForm.reset();
    courseModal.classList.remove("hidden");
  }

  function openEditCourseModal(course) {
    courseModalTitle.textContent = "Edit Course";
    courseForm.action = "/admin/update-courses/" + course._id;
    courseForm.code.value = course.code;
    courseForm.title.value = course.title;
    courseForm.unit.value = course.unit;
    courseForm.department.value = course.department;
    courseForm.lecturer.value = course.lecturer ? course.lecturer._id : '';

    // Set selected levels
    const levelSelect = courseForm.level;
    Array.from(levelSelect.options).forEach(opt => {
      opt.selected = course.level && course.level.includes(opt.value);
    });

    courseModal.classList.remove("hidden");
  }

  function closeCourseModal() {
    courseModal.classList.add("hidden");
  }

  courseForm.addEventListener("submit", () => {
    courseLoader.classList.remove("hidden");
    courseSubmitBtn.disabled = true;
    courseSubmitBtn.textContent = "Saving...";
  });
</script>

<%- include('../../partials/footer') %>
